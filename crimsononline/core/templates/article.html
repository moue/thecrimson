{% extends "base.html" %}

{% load crimson_filters %}

{% block title %}
	{{ article.headline }}
{% endblock %}

{% block inhead %}
	<link type="text/css" rel="stylesheet" href="/site_media/css/article.css" />
	<script src="http://code.jquery.com/jquery.js" type="text/javascript"></script>
    {% if article.maps.all %}
	<script src="/site_media/scripts/jmap.js" type="text/javascript"></script>
	<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAA--Z_bVpXIL9HJpQ50CHbfRRi_j0U6kJrkFvY4-OX2XYmEAa76BS5oixsScFqNPn7f8shoeoOZviFMg" type="text/javascript"></script>
	<script type="text/javascript">
		
        var gmaps = [];
        var markers = [];
        
		function buildMaps() {
			if (GBrowserIsCompatible()) {
                
                $('.mapdata').each(function (i) {
                    var pk = String(this.value); 
                    gmaps[i] = new GMap2(document.getElementById('map_' + pk));
                                       
                    gmaps[i].setCenter(new GLatLng($('#map_'+pk+'_center_lat').val(),$('#map_'+pk+'_center_lng').val()),Number($('#map_'+pk+'_zoom_level').val()));
                    switch ($('#map_'+pk+'_display_mode').val()) {
                        case 'Map':
                            gmaps[i].setMapType(G_NORMAL_MAP);
                            break;
                        case 'Satellite':
                            gmaps[i].setMapType(G_SATELLITE_MAP);
                            break;
                        case 'Hybrid':
                            gmaps[i].setMapType(G_HYBRID_MAP);
                            break;
                        default:
                            gmaps[i].setMapType(G_NORMAL_MAP);
                    }
                    gmaps[i].addControl(new GSmallMapControl());
                    gmaps[i].addControl(new GMapTypeControl(true));   
                    
                    markers[i] = [];
                    
                    $('.markerdata.map_'+pk).each(function (j) {
                        var markerpk = String(this.value);
                        latlng = new GLatLng($('#marker_'+markerpk+'_lat').val(),$('#marker_'+markerpk+'_lng').val());
                        markers[i][j] = new GMarker(latlng);
                        popup_text = $('#marker_'+markerpk+'_popup_text').val();
                        
                        if(popup_text != '') {
                            markers[i][j].bindInfoWindowHtml(popup_text, {maxWidth: 50});
                        }
                        gmaps[i].addOverlay(markers[i][j]);
                    });                    
                });
			}
		}
		
		$(document).ready(buildMaps);
	</script>
    {% endif %}
	
{% endblock %}

{% block body %}
	<div class="content">
		<div class="article">
			<h1>{{ article.headline }}</h1>
			<h2>{{ article.subheadline }}</h2>
			{% if article.image_gallery %}
                {{ article.image_gallery.cover_image|to_img_layout:"600," }}
		    {% endif %}
			<div class="byline">By {{ article.contributors.all|linkify|human_list }}
			</div>
			<div class="timestamp">Published: {{ article.issue.issue_date|date:"F d, Y" }}
			</div>
			<div>
                {% for map in article.maps.all %}
                    <div class="tall_photo" style="float: right; clear: right; width: {{map.width}}px; overflow:hidden;">
						<div id="map_{{map.pk}}" class="map" style="width: {{map.width}}px; height: {{map.height}}px"></div>
                        <input type="hidden" class="mapdata" id="map_{{map.pk}}_id" value="{{map.pk}}" name="map_{{map.pk}}_id"/>
                        <input type="hidden" id="map_{{map.pk}}_center_lat" value="{{map.center_lat}}" name="map_{{map.pk}}_center_lat"/>
                        <input type="hidden" id="map_{{map.pk}}_center_lng" value="{{map.center_lng}}" name="map_{{map.pk}}_center_lng"/>
                        <input type="hidden" id="map_{{map.pk}}_zoom_level" value="{{map.zoom_level}}" name="map_{{map.pk}}_zoom_level"/>
                        <input type="hidden" id="map_{{map.pk}}_display_mode" value="{{map.display_mode}}" name="map_{{map.pk}}_display_mode"/>
						<p class="caption">{{map.caption}}</p>
                        {% for marker in map.markers.all %}
                            <input type="hidden" class="markerdata map_{{map.pk}} marker_{{marker.pk}}" id="marker_{{marker.pk}}_id" value="{{marker.pk}}" name="marker_{{marker.pk}}_id"/>
                            <input type="hidden" class="map_{{map.pk}} marker_{{marker.pk}}" id="marker_{{marker.pk}}_lat" value="{{marker.lat}}" name="marker_{{marker.pk}}_lat"/>
                            <input type="hidden" class="map_{{map.pk}} marker_{{marker.pk}}" id="marker_{{marker.pk}}_lng" value="{{marker.lng}}" name="marker_{{marker.pk}}_lng"/>
                            <input type="hidden" class="map_{{map.pk}} marker_{{marker.pk}}" id="marker_{{marker.pk}}_popup_text" value="{{marker.popup_text}}" name="marker_{{marker.pk}}_popup_text"/>
                        {% endfor %}
                    </div>                   
                    
				{% endfor %}
				{{ article.text|escape|linebreaks }}
			</div>
			<div id="tags">
			    {% with article.tags.all as a_tags %}
			        {% if a_tags %}
			            Tags: 
			        {% endif %}
    			    {% for tag in a_tags %}
    			        <a class="tag" href="{{ tag.get_absolute_url }}">{{ tag.text }}</a>{% ifnotequal forloop.last 1 %}, {% endifnotequal %}
    			    {% endfor %}
			    {% endwith %}
			</div>
            <div id="disqus_thread"></div>
                <script type="text/javascript">
                    var disqus_developer = 1;
                </script>
                <script type="text/javascript" src="http://disqus.com/forums/crimson-alpha/embed.js"></script>
                <noscript>
                a href="http://crimson-alpha.disqus.com/?url=ref">View the discussion thread.</a>
                </noscript>
                <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
		</div>
	</div>
	<div class="columnRight">
		<p>here is a bunch of test text<br/>type type type type type type</p>
	</div>
	
{% endblock %}
